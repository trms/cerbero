From 004e7bb15e6c080697aecc40fa9181d56e1e8f1b Mon Sep 17 00:00:00 2001
From: Seungha Yang <seungha@centricular.com>
Date: Tue, 25 May 2021 20:10:34 +0900
Subject: [PATCH 1/2] deinterlace: Drop field-order field if outputting
 progressive

Progressive with field-order doesn't make sense
---
 gst/deinterlace/gstdeinterlace.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/gst/deinterlace/gstdeinterlace.c b/gst/deinterlace/gstdeinterlace.c
index 3a333f589..750e68f96 100644
--- a/gst/deinterlace/gstdeinterlace.c
+++ b/gst/deinterlace/gstdeinterlace.c
@@ -2951,6 +2951,11 @@ gst_deinterlace_setcaps (GstDeinterlace * self, GstPad * pad, GstCaps * caps,
     gst_caps_set_simple (srccaps, "interlace-mode", G_TYPE_STRING,
         "progressive", NULL);
 
+    {
+      GstStructure *s = gst_caps_get_structure (srccaps, 0);
+      gst_structure_remove_field (s, "field-order");
+    }
+
     gst_deinterlace_set_method (self, self->method_id);
     gst_deinterlace_method_setup (self->method, &self->vinfo);
   } else {
-- 
GitLab


From f46dd2f348e1ce67ad6ccf6e6046566b41eb9b2c Mon Sep 17 00:00:00 2001
From: Seungha Yang <seungha@centricular.com>
Date: Wed, 26 May 2021 00:23:56 +0900
Subject: [PATCH 2/2] deinterlace: Drop "field-order" field while transforming
 caps

Like other basetransform subclasses are doing, drop field
which can be converted by deinterlace.
---
 gst/deinterlace/gstdeinterlace.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/gst/deinterlace/gstdeinterlace.c b/gst/deinterlace/gstdeinterlace.c
index 750e68f96..3fba2d2b2 100644
--- a/gst/deinterlace/gstdeinterlace.c
+++ b/gst/deinterlace/gstdeinterlace.c
@@ -2539,11 +2539,18 @@ gst_deinterlace_getcaps (GstDeinterlace * self, GstPad * pad, GstCaps * filter)
   for (len = gst_caps_get_size (tmp2); len > 0; len--) {
     GstStructure *s = gst_caps_get_structure (tmp2, len - 1);
 
-    if (pad == self->sinkpad)
+    /* Drop fields which can be converted by us.
+     * Specifically "field-order" here.
+     * "field-order" with "progressive" and/or
+     * unspecified "interlace-mode" would cause negotiation issue */
+    gst_structure_remove_field (s, "field-order");
+
+    if (pad == self->sinkpad) {
       gst_structure_remove_field (s, "interlace-mode");
-    else
+    } else {
       gst_structure_set (s, "interlace-mode", G_TYPE_STRING, "progressive",
           NULL);
+    }
   }
 
   if (self->user_set_fields == GST_DEINTERLACE_ALL) {
-- 
GitLab

