From 6e9045fa8d49fc7d599b9e49be3c78a788aa3780 Mon Sep 17 00:00:00 2001
From: Ray Tiley <ray.tiley@trms.com>
Date: Mon, 15 Mar 2021 16:45:09 -0400
Subject: [PATCH 61/61] Revert "basetsmux: make use of
 gst_aggregator_finish_buffer_list"

This reverts commit 13376f88fecee6a84412a64c81a69f567d4d34b3.
---
 gst/mpegtsmux/gstbasetsmux.c | 28 +++++++++++++++++++++++++---
 1 file changed, 25 insertions(+), 3 deletions(-)

diff --git a/gst/mpegtsmux/gstbasetsmux.c b/gst/mpegtsmux/gstbasetsmux.c
index 6e66f4d87..4fda57b4d 100644
--- a/gst/mpegtsmux/gstbasetsmux.c
+++ b/gst/mpegtsmux/gstbasetsmux.c
@@ -880,6 +880,29 @@ new_packet_common_init (GstBaseTsMux * mux, GstBuffer * buf, guint8 * data,
   }
 }
 
+static GstFlowReturn
+finish_buffer_list (GstBaseTsMux * mux, GstBufferList * list)
+{
+  guint i;
+  guint l = gst_buffer_list_length (list);
+  GstFlowReturn ret = GST_FLOW_OK;
+
+  for (i = 0; i < l; i++) {
+    GstBuffer *buf = gst_buffer_list_get (list, i);
+
+    ret =
+        gst_aggregator_finish_buffer (GST_AGGREGATOR (mux),
+        gst_buffer_ref (buf));
+
+    if (ret != GST_FLOW_OK)
+      break;
+  }
+
+  gst_buffer_list_unref (list);
+
+  return ret;
+}
+
 static GstFlowReturn
 gst_base_ts_mux_push_packets (GstBaseTsMux * mux, gboolean force)
 {
@@ -901,8 +924,7 @@ gst_base_ts_mux_push_packets (GstBaseTsMux * mux, gboolean force)
   /* no alignment, just push all available data */
   if (align == 0) {
     buffer_list = gst_adapter_take_buffer_list (mux->out_adapter, av);
-    return gst_aggregator_finish_buffer_list (GST_AGGREGATOR (mux),
-        buffer_list);
+    return finish_buffer_list (mux, buffer_list);
   }
 
   align *= packet_size;
@@ -978,7 +1000,7 @@ gst_base_ts_mux_push_packets (GstBaseTsMux * mux, gboolean force)
     gst_buffer_list_add (buffer_list, buf);
   }
 
-  return gst_aggregator_finish_buffer_list (GST_AGGREGATOR (mux), buffer_list);
+  return finish_buffer_list (mux, buffer_list);
 }
 
 static GstFlowReturn
-- 
2.20.1.windows.1

